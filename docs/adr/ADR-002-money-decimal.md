# ADR-002: Денежные значения — Decimal/Numeric

Дата: 2025-11-03

Статус: Accepted

## Context

Денежные суммы не должны храниться/обрабатываться как `float` из‑за ошибок двоичной точности. Требуется согласованное округление и отсутствие накопления погрешностей.

## Decision

- В модели БД использовать `NUMERIC(10,2)` (SQLAlchemy `Numeric(10,2)`).
- В схемах API использовать `Decimal` (Pydantic) для поля `price_estimate`.
- JSON сериализация полагается на стандарт FastAPI (преобразование в число), бизнес-логика должна работать с `Decimal`.

Код: `app/models/wish.py`, `app/schemas/wish.py`.

## Consequences

- Плюсы: отсутствие погрешностей float, предсказуемые суммы.
- Минусы: возможные конвертации при работе с JSON и БД, апдейт схем/миграции.

## Alternatives

- `float`: простота, но риск накопления ошибок и неверные суммы.
- Хранить в «копейках» как `int`: надёжно, но хуже DX и требует явных конвертаций везде.

## Security impact

- Снижает риск финансовых расхождений (Integrity). Явные масштабы и округления уменьшают возможность злоупотреблений/ошибок округления.

## Rollout plan

- Обновление схем и модели; для продакшена — миграция БД. В учебном окружении — пересоздание таблиц на старте.

## Links

- NFR: `docs/security-nfr/NFR.md` (Нормализация дат/денег)
- Threat Model: `docs/threat-model/STRIDE.md` (Tampering), `docs/threat-model/RISKS.md`
- Тесты: `tests/test_errors.py` (проверка CRUD), совместимо с числами
- Коммиты: см. PR p05-secure-coding → main
