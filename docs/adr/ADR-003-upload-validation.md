# ADR-003: Безопасная загрузка файлов (magic bytes, лимиты, канонизация)

Дата: 2025-11-03

Статус: Accepted

## Context

Необходимо безопасно обрабатывать потенциальные загрузки изображений: ограничить размер, тип контента, исключить path traversal и симлинки.

## Decision

- Определение типа по сигнатурам (magic bytes) PNG/JPEG, игнорируем `Content-Type` клиента.
- Ограничение размера файла `MAX_BYTES = 5MB`.
- Имя файла — `UUID` + расширение по типу.
- Канонизация пути и запрет симлинков в родителях.

Код: `app/utils/upload.py`.

## Consequences

- Плюсы: защита от неправильных типов/больших файлов, базовая защита от traversal.
- Минусы: поддерживаем только PNG/JPEG, требуется хранение в безопасной директории.

## Alternatives

- Полагаться на MIME от клиента — небезопасно.
- Использовать стороннюю либу для сниффинга — гибко, но лишняя зависимость для учебной цели.

## Security impact

- Снижает риск DoS по размеру, LFI/path traversal, выполнение нежелательных форматов.

## Rollout plan

- Утилита готова к использованию; интеграция эндпоинта при необходимости. Проверка — юнит‑тесты.

## Links

- NFR: `docs/security-nfr/NFR.md` (Валидация загрузок, лимиты)
- Threat Model: `docs/threat-model/STRIDE.md` (Tampering), `docs/threat-model/RISKS.md`
- Тесты: `tests/test_upload.py`
- Коммиты: см. PR p05-secure-coding → main

